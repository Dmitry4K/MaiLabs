<!-- 
    Восьмая лабораторная работа
    Студент: Коростелев Дмитрий Васильевич
    Группа: М8О-106М-22
    Номер по списку: 5
    Условие задания:
    Скачать с портала data.mos.ru  данные в формате JSON из некоторого набора данных (по выбору)
    Полученный JSON-файл будет в одну строку. Чтобы его структурировать, используйте валидацию  в  https://jsonlint.com/
    На JS написать функцию, которая строит таблицу с данными о выбранных объектах. Колонок не менее 4-х.
    Получить те же данные через API по протоколу OpenData

-->
<!DOCTYPE html>
<script src="https://code.jquery.com/jquery-3.6.3.js"></script>
<script src="https://code.jquery.com/color/jquery.color-2.2.0.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous"><head> -->
    <h1>Восьмая лабораторная работа</h1>
    <hr>
    <h3>Студент: Коростелев Дмитрий Васильевич</h3>
    <h3>Группа: М8О-106М-22</h3>
    <h3>Условие</h3>
    Условие задания:
    Скачать с портала data.mos.ru  данные в формате JSON из некоторого набора данных (по выбору)<br>
    Полученный JSON-файл будет в одну строку. Чтобы его структурировать, используйте валидацию  в  https://jsonlint.com/<br>
    На JS написать функцию, которая строит таблицу с данными о выбранных объектах. Колонок не менее 4-х.<br>
    Получить те же данные через API по протоколу OpenData<br>
</head>
<hr>
<body>
    Введите API ключ для получения данных из data.mos.ru: <input type="password" id='api_key'>
    <br>
    Номер старницы: <input type="number" min="0" id='page_number' value="0">
    <br>
    Количество записей на странице: <input type="number" min="0" id='page_size' value="10">
    <br>
    <button onclick="fetchData()">Получить данные из data.mos</button><br>
    <br>
    <button onclick="openInNewTab()">Открыть запрашиваемые данные в новой вкладке</button><br>
    <br>
    Вставьте содержимое JSON файла, которое нужно отобразить:<br>
    <textarea type="text" id="json_placer"></textarea><br>
    <button onclick="buildPage()">Построить страницу</button><br>
    <br>
    <div id="table-container"></div>
</body>
<script>
    function openInNewTab() {
        window.open('https://apidata-new.mos.ru/v1/datasets/530/rows?api_key='+$('#api_key').val() + `&$skip=${$('#page_size').val() * $('#page_number').val()}` + `&$top=${$('#page_size').val()}` + ``, '_blank').focus();
    }
    function fetchData() {
        fetch('https://apidata-new.mos.ru/v1/datasets/530/rows?api_key='+$('#api_key').val() + `&$skip=${$('#page_size').val() * $('#page_number').val()}` + `&$top=${$('#page_size').val()}`)
            .then(function(data) {
                data.text().then((text) => $('#json_placer').val(text))
            })
    }

    function buildPage() {
        var htmlTableStr = '<table class="table"><tr><th>ID</th><th>Название объекта</th><th>Административный округ</th><th>Район</th></tr>'
        jsonData = JSON.parse($('#json_placer').val())
        for (var i = 0; i < jsonData.length; i++) {
            var name = jsonData[i]['Cells']['EnsembleNameOnDoc']
            var admArea = jsonData[i]['Cells']['AdmArea']
            var district = jsonData[i]['Cells']['District']
            var id = jsonData[i]['Cells']['ID']

            htmlTableStr += `<tr><td>${id}</td><td>${name}</td><td>${admArea}</td><td>${district}</td></tr>`
        }
        htmlTableStr += '</tr></table>'
        $('#table-container').html(htmlTableStr)
    }
</script>
<style>
    #json_placer {
        width: 100%;
        height: 300px;
    }
</style>